'use client';

import { jsPDF } from 'jspdf';
import autoTable from 'jspdf-autotable';
import { format } from 'date-fns';

// Helper function to add header to PDF
const addPDFHeader = async (doc, subtitle = 'KAAT RATE LIST') => {
  const pageWidth = doc.internal.pageSize.width;
  
  // Add company name at top
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(0, 0, 0);
  doc.text('SS TRANSPORT CORPORATION', pageWidth / 2, 15, { align: 'center' });
  
  // Add subtitle
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(16, 185, 129); // Emerald color
  doc.text(subtitle, pageWidth / 2, 25, { align: 'center' });
  
  // Add date
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(100, 100, 100);
  const currentDate = format(new Date(), 'dd MMM yyyy, hh:mm a');
  doc.text(`Generated: ${currentDate}`, pageWidth / 2, 32, { align: 'center' });
  
  // Add line
  doc.setDrawColor(16, 185, 129);
  doc.setLineWidth(0.5);
  doc.line(10, 35, pageWidth - 10, 35);
};

// Helper function to add footer to PDF
const addPDFFooter = (doc) => {
  const pageCount = doc.internal.getNumberOfPages();
  const pageWidth = doc.internal.pageSize.width;
  const pageHeight = doc.internal.pageSize.height;
  
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    
    // Page number on left
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text(
      `Page ${i} of ${pageCount}`,
      20,
      pageHeight - 10
    );
    
    // Generated by MoveSure
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(40, 40, 40);
    doc.text(
      'Generated by MoveSure',
      pageWidth / 2,
      pageHeight - 10,
      { align: 'center' }
    );
  }
};

// Generate Kaat Rates PDF
export const generateKaatRatesPDF = async (kaatRates, cities, transports, settings) => {
  try {
    console.log('üîÑ Generating Kaat Rates PDF...');
    
    // Create PDF document
    const doc = new jsPDF('landscape', 'mm', 'a4');
    
    // Add header
    await addPDFHeader(doc, settings.subtitle || 'KAAT RATE LIST');
    
    // Filter rates based on settings
    let filteredRates = [...kaatRates];
    
    // Filter by status
    if (!settings.includeInactive) {
      filteredRates = filteredRates.filter(r => r.is_active);
    }
    
    // Filter by transport
    if (settings.filterType === 'transport' && settings.selectedTransport) {
      filteredRates = filteredRates.filter(r => r.transport_id === settings.selectedTransport);
    }
    
    // Filter by city
    if (settings.filterType === 'city' && settings.selectedCity) {
      filteredRates = filteredRates.filter(r => r.destination_city_id === settings.selectedCity);
    }
    
    // Sort rates
    filteredRates.sort((a, b) => {
      if (settings.sortBy === 'transport') {
        const nameA = (a.transport_name || a.transport?.transport_name || '').toLowerCase();
        const nameB = (b.transport_name || b.transport?.transport_name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      } else if (settings.sortBy === 'city') {
        const cityA = (a.destination?.city_name || '').toLowerCase();
        const cityB = (b.destination?.city_name || '').toLowerCase();
        return cityA.localeCompare(cityB);
      } else if (settings.sortBy === 'rate') {
        const rateA = parseFloat(a.rate_per_kg || a.rate_per_pkg || 0);
        const rateB = parseFloat(b.rate_per_kg || b.rate_per_pkg || 0);
        return rateA - rateB;
      }
      return 0;
    });
    
    // Add filter info if applicable
    let yPosition = 40;
    if (settings.filterType === 'transport' && settings.selectedTransport) {
      const transport = transports?.find(t => t.id === settings.selectedTransport);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(139, 92, 246); // Purple
      doc.text(`Transport: ${transport?.transport_name || 'Unknown'}`, 20, yPosition);
      yPosition += 5;
    }
    
    if (settings.filterType === 'city' && settings.selectedCity) {
      const city = cities?.find(c => c.id === settings.selectedCity);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(59, 130, 246); // Blue
      doc.text(`Destination City: ${city?.city_name || 'Unknown'}`, 20, yPosition);
      yPosition += 5;
    }
    
    // Prepare table data
    const tableData = filteredRates.map((rate, index) => {
      const transportName = rate.transport_name || rate.transport?.transport_name || 'N/A';
      const transportCity = rate.transport?.city_name || '-';
      const gstNumber = rate.transport?.gst_number || '-';
      
      const destCity = rate.destination?.city_name || cities?.find(c => c.id === rate.destination_city_id)?.city_name || 'Unknown';
      const destCode = rate.destination?.city_code || cities?.find(c => c.id === rate.destination_city_id)?.city_code || '-';
      
      const goodsType = rate.goods_type || '-';
      
      const pricingMode = rate.pricing_mode === 'per_kg' ? 'KG' : 
                          rate.pricing_mode === 'per_pkg' ? 'PACKAGE' : 'HYBRID';
      
      let rateDetails = '';
      if (rate.pricing_mode === 'per_kg' || rate.pricing_mode === 'hybrid') {
        rateDetails += `‚Çπ${parseFloat(rate.rate_per_kg || 0).toFixed(2)}/kg`;
      }
      if (rate.pricing_mode === 'per_pkg' || rate.pricing_mode === 'hybrid') {
        if (rateDetails) rateDetails += '\n';
        rateDetails += `‚Çπ${parseFloat(rate.rate_per_pkg || 0).toFixed(2)}/pkg`;
      }
      
      const minCharge = `‚Çπ${parseFloat(rate.min_charge || 0).toFixed(0)}`;
      
      const transitDays = rate.metadata?.transit_days ? `${rate.metadata.transit_days} days` : '-';
      
      const status = rate.is_active ? '‚úì Active' : '‚úó Inactive';
      
      return [
        index + 1,
        transportName,
        transportCity,
        gstNumber,
        `${destCity}\n(${destCode})`,
        goodsType,
        pricingMode,
        rateDetails,
        minCharge,
        transitDays,
        status
      ];
    });
    
    // Generate table
    autoTable(doc, {
      startY: yPosition + 3,
      head: [[
        '#',
        'Transport Name',
        'Hub City',
        'GST Number',
        'Destination\n(Code)',
        'Goods Type',
        'Mode',
        'Rate',
        'Min Charge',
        'Transit Days',
        'Status'
      ]],
      body: tableData,
      theme: 'grid',
      headStyles: {
        fillColor: [16, 185, 129], // Emerald
        textColor: [255, 255, 255],
        fontStyle: 'bold',
        fontSize: 8,
        halign: 'center',
        valign: 'middle'
      },
      bodyStyles: {
        fontSize: 7,
        cellPadding: 2,
        valign: 'top'
      },
      columnStyles: {
        0: { cellWidth: 8, halign: 'center' }, // #
        1: { cellWidth: 35 }, // Transport Name
        2: { cellWidth: 25 }, // Hub City
        3: { cellWidth: 25 }, // GST
        4: { cellWidth: 30, halign: 'center' }, // Destination
        5: { cellWidth: 20 }, // Goods Type
        6: { cellWidth: 18, halign: 'center' }, // Mode
        7: { cellWidth: 25, halign: 'right' }, // Rate
        8: { cellWidth: 20, halign: 'right' }, // Min Charge
        9: { cellWidth: 20, halign: 'center' }, // Transit Days
        10: { cellWidth: 18, halign: 'center' } // Status
      },
      alternateRowStyles: {
        fillColor: [249, 250, 251] // Light gray
      },
      didParseCell: function(data) {
        // Highlight inactive rows
        if (data.section === 'body' && data.column.index === 10) {
          const statusText = data.cell.raw;
          if (statusText && statusText.includes('Inactive')) {
            data.row.cells.forEach(cell => {
              cell.styles.textColor = [156, 163, 175]; // Gray
              cell.styles.fontStyle = 'italic';
            });
          }
        }
      },
      margin: { top: yPosition + 5, left: 10, right: 10 },
      didDrawPage: function(data) {
        // Add watermark on each page
        doc.setFontSize(60);
        doc.setTextColor(200, 200, 200);
        doc.setFont('helvetica', 'bold');
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        doc.text('SS TRANSPORT', pageWidth / 2, pageHeight / 2, {
          align: 'center',
          angle: 45,
          opacity: 0.1
        });
      }
    });
    
    // Add summary at the end
    const finalY = doc.lastAutoTable.finalY || yPosition + 50;
    const pageHeight = doc.internal.pageSize.height;
    
    if (finalY + 30 < pageHeight - 20) {
      doc.setDrawColor(16, 185, 129);
      doc.setLineWidth(0.3);
      doc.line(10, finalY + 5, doc.internal.pageSize.width - 10, finalY + 5);
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text('Summary:', 20, finalY + 12);
      
      doc.setFont('helvetica', 'normal');
      const activeCount = filteredRates.filter(r => r.is_active).length;
      const inactiveCount = filteredRates.filter(r => !r.is_active).length;
      const uniqueTransports = new Set(filteredRates.map(r => r.transport_id || r.transport_name)).size;
      const uniqueCities = new Set(filteredRates.map(r => r.destination_city_id)).size;
      
      doc.text(`Total Rates: ${filteredRates.length}`, 20, finalY + 18);
      doc.text(`Active: ${activeCount}`, 70, finalY + 18);
      doc.text(`Inactive: ${inactiveCount}`, 110, finalY + 18);
      doc.text(`Unique Transports: ${uniqueTransports}`, 160, finalY + 18);
      doc.text(`Unique Destinations: ${uniqueCities}`, 230, finalY + 18);
    }
    
    // Add footer to all pages
    addPDFFooter(doc);
    
    // Generate filename
    let filename = 'kaat-rates';
    if (settings.filterType === 'transport' && settings.selectedTransport) {
      const transport = transports?.find(t => t.id === settings.selectedTransport);
      filename = `kaat-${(transport?.transport_name || 'transport').toLowerCase().replace(/\s+/g, '-')}`;
    } else if (settings.filterType === 'city' && settings.selectedCity) {
      const city = cities?.find(c => c.id === settings.selectedCity);
      filename = `kaat-${(city?.city_name || 'city').toLowerCase().replace(/\s+/g, '-')}`;
    }
    filename += `-${format(new Date(), 'dd-MMM-yyyy')}.pdf`;
    
    // Save PDF
    doc.save(filename);
    
    console.log('‚úÖ PDF generated successfully:', filename);
    return { success: true, filename };
    
  } catch (error) {
    console.error('‚ùå Error generating PDF:', error);
    throw error;
  }
};
